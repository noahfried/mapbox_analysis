---
title: "main"
author: "nwfried"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Load libraries
```{r}
library(sf)
library(tigris)
library(tidyverse)
library(jsonlite)
library(knitr)
```

```{r}
filepath <- "~/Documents/congestion_pricing/mapbox_drive_times/data"
```
Initialise variables for congestion zone
```{r}
cong_zips <-c("10036", "10038", "10280", "10282")
for (i in 10001:10022) {
  cong_zips <- append(cong_zips, as.character(i))
}
```

<!-- determine whether trip started or ended in congestion zone -->
<!-- ```{r} -->
<!-- dec8 <- dec8 %>% mutate( -->
<!--   inputzip = as.character(inputzip), -->
<!--   zip_commute = as.character(zip_commute), -->
<!--   cong = as.integer(inputzip %in% cong_zips | zip_commute %in% cong_zips) -->
<!-- ) -->
<!-- ``` -->
Pull GIS info for Manhattan
```{r}
newyork <- tigris::counties(state = "NY", class = "sf") %>%
  st_transform(crs = "WGS84")
manhattan <- newyork %>% filter(NAME == "New York") %>%
  st_transform(crs = "+proj=longlat +datum=WGS84")
brooklyn <- newyork %>% filter(NAME == "Kings") %>%
  st_transform(crs = "WGS84")
bronx <- newyork %>% filter(NAME == "Bronx") %>%
  st_transform(crs = "WGS84")
staten_island <- newyork %>% filter(NAME == "Richmond") %>%
  st_transform(crs = "WGS84")
queens <- newyork %>% filter(NAME == "Queens") %>%
  st_transform(crs = "WGS84") #probably a better way to just pull in WGS84 coords lol
nyc <- newyork %>% filter(NAME == "New York" | NAME == "Kings" | NAME == "Bronx" | NAME == "Richmond" | NAME == "Queens") %>% st_transform(crs = "WGS84")
manhattan_planar <- manhattan %>% st_transform(32618)
```
Pull GIS info for congestion zip codes
```{r}
cong_zone <- tigris::zctas(year = "2020", class = "sf")
cong_zone <- cong_zone %>% filter(ZCTA5CE20 %in% cong_zips) %>% st_transform(crs = "WGS84")
```
```{r}
ggplot() + geom_sf(data = manhattan, fill = "lightblue", color = "darkblue")
```
```{r}
make_sf <- function(df){
  df<- df %>% filter(duration!= 0) %>% left_join(jan15_less) %>%
  rowwise() %>%
  filter(duration_min != 0, coordinates != "{}") %>%
  mutate(
    geometry = list(
      st_linestring(
        as.matrix(fromJSON(coordinates))
      )
    )
  ) %>%
  st_as_sf(crs = 4326)
  return(df)
}
```
```{r}
analyse_sf <- function(sf){
  sf <- sf %>% mutate(
  cong = sapply(st_intersects(geometry, cong_zone), function(x) length(x) > 0),
  manhattan = sapply(st_intersects(geometry, manhattan), function(x) length(x) > 0),
  brooklyn = sapply(st_intersects(geometry, brooklyn), function(x) length(x) > 0),
  queens = sapply(st_intersects(geometry, queens), function(x) length(x) > 0),
  bronx = sapply(st_intersects(geometry, bronx), function(x) length(x) > 0),
  staten_island = sapply(st_intersects(geometry, staten_island), function(x) length(x) > 0),
  nyc = sapply(st_intersects(geometry, nyc), function(x) length(x) > 0))%>%
  st_transform(32618) %>% mutate(
  crosses_manhattan = lengths(st_crosses(geometry, manhattan_planar)) > 0
)
  return(sf)
}
```


```{r}
jan15 <- read_delim(file.path(filepath, "mapbox_output_2025-01-15_HH08.csv"))
jan15_sf <- jan15 %>% rowwise() %>%
  filter(duration_min != 0) %>%
  mutate(
    geometry = list(
      st_linestring(
        as.matrix(fromJSON(coordinates))
      )
    )
  ) %>%
  st_as_sf(crs = 4326)
```
turn this into function
```{r}
jan15_less <- jan15 %>% select(orig_long, orig_lat, dest_long, dest_lat, coordinates) %>% rowwise() %>%
  filter(coordinates != '{}') %>%
  mutate(
    geometry = list(
      st_linestring(
        as.matrix(fromJSON(coordinates))
      )
    )
  ) %>%
  st_as_sf(crs = 4326)
jan15_less <- analyse_sf(jan15_less)
jan15_less <- jan15_less %>% st_drop_geometry()

```

```{r}
cong_info <- function(df) {
  mean <- df %>% st_drop_geometry %>%
    ungroup() %>%
    filter(cong == TRUE)%>%
    summarise(mean_duration = mean(duration_min), median = median(duration_min), n = n())
  return(mean)
}
```
```{r}
trip_info <- function(df) {
  mean <- df%>%st_drop_geometry%>%
    ungroup()%>%
  summarise(mean_duration = mean(duration_min), median = median(duration_min), n = n())
  return(mean) 
}
```

```{r}
extract_date_hour <- function(file_name) {
  match <- str_match(file_name, "mapbox_output_(\\d{4}-\\d{2}-\\d{2})_HH(\\d{2})")
  list(
    date = match[2],  # Extracted date (YYYY-MM-DD)
    hour = match[3]   # Extracted hour (HH)
  )
}
```

```{r}
# Read all CSV files in a folder
process_csv_files <- function(folder_path) {
  # List all CSV files in the folder
  csv_files <- list.files(path = folder_path, pattern = "\\.csv$", full.names = TRUE)
  # Empty dataframe to store results
 results_df <- data.frame(
    date = character(),
    hour = character(),
    cong_mean = numeric(),
    trip_mean = numeric(),
    stringsAsFactors = FALSE
  )

  # Loop over all files
  for (file in csv_files) {
    extracted <- extract_date_hour(basename(file))
    date_hour <- paste0(extracted$date, "_", extracted$hour)  # Combine date and hour for unique naming

    # Read the CSV file
    data <- read.csv(file)
    
    # Apply the functions
    sf_data <- left_join(data, jan15_less, relationship = "many-to-many") %>% filter(duration!=0, coordinates != '{}')
    congestion_result <- cong_info(sf_data)
    trip_result <- trip_info(sf_data)
    # Store the result in results dataframe
   results_df <- rbind(
      results_df,
      data.frame(
        date = extracted$date,
        hour = extracted$hour,
        cong_mean = congestion_result,
        trip_mean = trip_result,
        stringsAsFactors = FALSE
      )
    )

  }
  
  return(results_df)
}
```
```{r}
results <- process_csv_files(filepath)
```
Mean trip duration with the congestion zone against time; line indicates date congestion relief begins.
```{r}
ggplot(results, aes(x = as.POSIXct(paste(date, hour), format = "%Y-%m-%d %H"), y = cong_mean.mean_duration)) +
  geom_line(color = "blue") +
  geom_point(color = "red") +
  geom_vline(xintercept = as.POSIXct("2025-01-05 00:00", format = "%Y-%m-%d %H"), linetype = "solid", color = "black", size = 0.8) +
  labs(
    x = "Time",
    y = "Mean Duration",
    title = "Mean Congestion Duration Over Time"
  ) +
  theme_minimal()
```
Median trip duration with the congestion zone against time; line indicates date congestion relief begins.
```{r}
results1 <- results[-69, ]
ggplot(results1, aes(x = as.POSIXct(paste(date, hour), format = "%Y-%m-%d %H"), y = cong_mean.median)) +
  geom_line(color = "blue") +
  geom_point(color = "red") +
  geom_vline(xintercept = as.POSIXct("2025-01-05 00:00", format = "%Y-%m-%d %H"), linetype = "solid", color = "black", size = 0.8) +
  labs(
    x = "Time",
    y = "Median Duration",
    title = "Median Congestion Duration Over Time"
  ) +
  theme_minimal()
```
```{r}
results$datetime <- as.POSIXct(paste(results$date, results$hour), format = "%Y-%m-%d %H")
ggplot(results, aes(x = datetime)) +
  geom_line(aes(y = cong_mean.mean_duration, color = "Mean Congestion Duration"), size = 1) +
  geom_line(aes(y = trip_mean.mean_duration, color = "Mean Trip Duration"), size = 1) +
  geom_point(aes(y = cong_mean.mean_duration, color = "Mean Congestion Duration"), size = 2) +
  geom_point(aes(y = trip_mean.mean_duration, color = "Mean Trip Duration"), size = 2) +
  geom_vline(
    xintercept = as.POSIXct("2025-01-05 00:00", format = "%Y-%m-%d %H"),
    linetype = "dashed", color = "black", size = 0.8
  ) +
  labs(
    x = "Time",
    y = "Duration (Minutes)",
    title = "Congestion vs Trip Duration Over Time",
    color = "Legend"
  ) +
  theme_minimal()
```
Summary statistics:
```{r}
cong_stats <- results[-c(1:45), ] %>%
  summarise(mean_cong = mean(cong_mean.mean_duration), mean_trip = mean(trip_mean.mean_duration), median_cong = median(cong_mean.median), median_trip = median(trip_mean.median))
before_cong <- results[1:45, ] %>%
  summarise(mean_cong = mean(cong_mean.mean_duration), mean_trip = mean(trip_mean.mean_duration), median_cong = median(cong_mean.median), median_trip = median(trip_mean.median))
```
```{r}
cong_stats
before_cong
```


